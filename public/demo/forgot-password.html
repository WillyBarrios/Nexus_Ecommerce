<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña - Nexus E-commerce</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="bi bi-key"></i> Recuperar Contraseña</h1>
            <p>Ingresa tu correo electronico para recibir instrucciones</p>
        </div>

        <div class="nav-menu">
            <a href="index.html" class="nav-btn"><i class="bi bi-house"></i> Inicio</a>
            <a href="auth.html" class="nav-btn"><i class="bi bi-person"></i> Login/Registro</a>
            <a href="shop.html" class="nav-btn"><i class="bi bi-shop"></i> Tienda</a>
            <a href="cart.html" class="nav-btn"><i class="bi bi-cart"></i> Carrito</a>
            <a href="orders.html" class="nav-btn"><i class="bi bi-box"></i> Mis Pedidos</a>
        </div>

        <div class="content">
            <div id="authInfo"></div>

            <!-- Paso 1: Solicitar recuperacion -->
            <div class="card" id="stepRequest">
                <div class="card-header">
                    <i class="bi bi-envelope"></i> Paso 1: Solicitar Recuperacion
                </div>
                <form id="forgotForm">
                    <div class="form-group">
                        <label>Correo Electronico</label>
                        <input type="email" id="forgotEmail" placeholder="tu@email.com" required>
                        <small style="color: #666;">Te enviaremos un token para restablecer tu contraseña</small>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="bi bi-send"></i> Enviar Token
                    </button>
                </form>
            </div>

            <!-- Paso 2: Restablecer contraseña -->
            <div class="card" id="stepReset" style="display: none;">
                <div class="card-header">
                    <i class="bi bi-shield-lock"></i> Paso 2: Nueva Contraseña
                </div>
                <form id="resetForm">
                    <div class="form-group">
                        <label>Correo Electronico</label>
                        <input type="email" id="resetEmail" readonly>
                    </div>
                    <div class="form-group">
                        <label>Token de Recuperacion</label>
                        <input type="text" id="resetToken" required>
                        <small style="color: #666;">Copia el token que aparece abajo en el codigo</small>
                    </div>
                    <div class="form-group">
                        <label>Nueva Contraseña</label>
                        <input type="password" id="resetPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Confirmar Contraseña</label>
                        <input type="password" id="resetPasswordConfirm" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="bi bi-check-circle"></i> Restablecer Contraseña
                    </button>
                    <button type="button" class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="volverPaso1()">
                        <i class="bi bi-arrow-left"></i> Volver al Paso 1
                    </button>
                </form>
            </div>

            <!-- Mensaje de exito -->
            <div class="card" id="stepSuccess" style="display: none;">
                <div class="card-header" style="background: #28a745; color: white;">
                    <i class="bi bi-check-circle"></i> Contraseña Restablecida
                </div>
                <div style="padding: 20px; text-align: center;">
                    <i class="bi bi-check-circle" style="font-size: 64px; color: #28a745;"></i>
                    <h3 style="margin: 20px 0;">Tu contraseña ha sido actualizada exitosamente</h3>
                    <p style="color: #666;">Ya puedes iniciar sesion con tu nueva contraseña</p>
                    <a href="auth.html" class="btn btn-primary" style="margin-top: 20px;">
                        <i class="bi bi-box-arrow-in-right"></i> Ir a Login
                    </a>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-code-square"></i> Codigo de la Peticion
                </div>
                <div class="code-viewer" id="codeViewer">
                    <p style="color: #666;">El codigo de la peticion aparecera aqui...</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> Informacion
                </div>
                <div style="padding: 15px;">
                    <h4>Como funciona:</h4>
                    <ol style="line-height: 1.8;">
                        <li><strong>Paso 1:</strong> Ingresa tu correo electronico y haz clic en "Enviar Token"</li>
                        <li><strong>Paso 2:</strong> El sistema generara un token (aparecera en el codigo abajo)</li>
                        <li><strong>Paso 3:</strong> Copia el token y pegalo en el formulario del Paso 2</li>
                        <li><strong>Paso 4:</strong> Ingresa tu nueva contraseña y confirma</li>
                        <li><strong>Paso 5:</strong> Inicia sesion con tu nueva contraseña</li>
                    </ol>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <strong><i class="bi bi-exclamation-triangle"></i> Nota de Desarrollo:</strong>
                        <p style="margin: 10px 0 0 0;">En produccion, el token se enviaria por correo electronico. Para este demo, el token aparece en el codigo de respuesta para que puedas probarlo facilmente.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentEmail = '';
        let currentToken = '';

        // Formulario de solicitud de recuperacion
        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            currentEmail = email;

            const requestData = { email };
            Utils.showCode('POST /api/password/forgot', { request: requestData });

            const result = await API.post('/password/forgot', requestData);
            
            Utils.showCode('POST /api/password/forgot', { 
                request: requestData, 
                response: result 
            });

            if (result.ok) {
                Utils.showAlert('Token generado! Copia el token del codigo de abajo', 'success');
                
                // Guardar el token si viene en la respuesta (solo para desarrollo)
                if (result.data.token) {
                    currentToken = result.data.token;
                }
                
                // Mostrar paso 2
                document.getElementById('stepRequest').style.display = 'none';
                document.getElementById('stepReset').style.display = 'block';
                document.getElementById('resetEmail').value = email;
                
                // Si tenemos el token, pre-llenarlo (solo para desarrollo)
                if (currentToken) {
                    document.getElementById('resetToken').value = currentToken;
                }
            } else {
                Utils.showAlert(result.data.message || 'Error al solicitar recuperacion', 'error');
            }
        });

        // Formulario de restablecimiento de contraseña
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            const token = document.getElementById('resetToken').value;
            const password = document.getElementById('resetPassword').value;
            const passwordConfirm = document.getElementById('resetPasswordConfirm').value;

            if (password !== passwordConfirm) {
                Utils.showAlert('Las contrasenas no coinciden', 'error');
                return;
            }

            const requestData = {
                email,
                token,
                password,
                password_confirmation: passwordConfirm
            };

            Utils.showCode('POST /api/password/reset', { request: requestData });

            const result = await API.post('/password/reset', requestData);
            
            Utils.showCode('POST /api/password/reset', { 
                request: requestData, 
                response: result 
            });

            if (result.ok) {
                Utils.showAlert('Contraseña restablecida exitosamente!', 'success');
                
                // Mostrar mensaje de exito
                document.getElementById('stepReset').style.display = 'none';
                document.getElementById('stepSuccess').style.display = 'block';
            } else {
                Utils.showAlert(result.data.message || 'Error al restablecer contraseña', 'error');
            }
        });

        // Funcion para volver al paso 1
        function volverPaso1() {
            document.getElementById('stepReset').style.display = 'none';
            document.getElementById('stepRequest').style.display = 'block';
            document.getElementById('forgotForm').reset();
            currentEmail = '';
            currentToken = '';
        }

        // Si ya esta autenticado, mostrar mensaje
        if (Auth.isAuthenticated()) {
            Utils.showAlert('Ya has iniciado sesion. Si quieres cambiar tu contraseña, cierra sesion primero.', 'info');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos - Nexus E-commerce</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="bi bi-box-seam"></i> Mis Pedidos</h1>
            <p>Historial de compras</p>
        </div>

        <div class="nav-menu">
            <a href="index.html" class="nav-btn"><i class="bi bi-house"></i> Inicio</a>
            <a href="auth.html" class="nav-btn"><i class="bi bi-person"></i> Login/Registro</a>
            <a href="shop.html" class="nav-btn"><i class="bi bi-shop"></i> Tienda</a>
            <a href="cart.html" class="nav-btn"><i class="bi bi-cart"></i> Carrito</a>
            <a href="orders.html" class="nav-btn active"><i class="bi bi-box"></i> Mis Pedidos</a>
            <a href="payments.html" class="nav-btn"><i class="bi bi-credit-card"></i> Pagos</a>
        </div>

        <div class="content">
            <div id="authInfo"></div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-ul"></i> Lista de Pedidos
                </div>
                <div id="ordersList">
                    <div class="loading">Cargando pedidos...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-code-square"></i> Codigo de la Peticion
                </div>
                <div class="code-viewer" id="codeViewer">
                    <p style="color: #666;">El codigo de la peticion aparecera aqui...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        if (!Utils.requireAuth()) {
            // Redirigir si no esta autenticado
        }

        let orders = [];

        async function loadOrders() {
            Utils.showCode('GET /pedidos', {});

            const result = await API.get('/pedidos');
            
            Utils.showCode('GET /pedidos', { response: result });

            if (result.ok) {
                orders = result.data.data || [];
                renderOrders();
            } else {
                document.getElementById('ordersList').innerHTML = '<p style="color: red;">Error al cargar pedidos</p>';
            }
        }

        function getStatusBadge(estado) {
            const badges = {
                'pendiente': '<span style="background: #ffc107; color: #000; padding: 5px 15px; border-radius: 15px; font-weight: 600;">Pendiente</span>',
                'pagado': '<span style="background: #28a745; color: white; padding: 5px 15px; border-radius: 15px; font-weight: 600;">Pagado</span>',
                'enviado': '<span style="background: #17a2b8; color: white; padding: 5px 15px; border-radius: 15px; font-weight: 600;">Enviado</span>',
                'entregado': '<span style="background: #28a745; color: white; padding: 5px 15px; border-radius: 15px; font-weight: 600;">Entregado</span>',
                'cancelado': '<span style="background: #dc3545; color: white; padding: 5px 15px; border-radius: 15px; font-weight: 600;">Cancelado</span>'
            };
            return badges[estado] || estado;
        }

        function renderOrders() {
            const container = document.getElementById('ordersList');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="bi bi-inbox" style="font-size: 4em; color: #ccc;"></i>
                        <h3 style="color: #666; margin-top: 20px;">No tienes pedidos aun</h3>
                        <a href="shop.html" class="btn btn-primary" style="margin-top: 20px; text-decoration: none;">
                            <i class="bi bi-shop"></i> Ir a la Tienda
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="card" style="margin-bottom: 15px; background: #f8f9fa;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0; color: #667eea;">Pedido #${order.numero_pedido}</h4>
                            <small style="color: #666;">Fecha: ${new Date(order.fecha_creacion).toLocaleDateString()}</small>
                        </div>
                        <div>
                            ${getStatusBadge(order.estado)}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding: 15px; background: white; border-radius: 8px;">
                        <div>
                            <strong>Total:</strong><br>
                            <span style="font-size: 1.3em; color: #667eea;">${Utils.formatPrice(order.monto_total)}</span>
                        </div>
                        <div>
                            <strong>Metodo de Pago:</strong><br>
                            ${order.pago?.metodo_pago || 'N/A'}
                        </div>
                        <div style="text-align: right;">
                            <button onclick="viewOrderDetails(${order.id_pedido})" class="btn btn-primary">
                                <i class="bi bi-eye"></i> Ver Detalles
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function viewOrderDetails(orderId) {
            Utils.showCode(`GET /pedidos/${orderId}`, {});

            const result = await API.get(`/pedidos/${orderId}`);
            
            Utils.showCode(`GET /pedidos/${orderId}`, { response: result });

            if (result.ok) {
                const order = result.data.data;
                let detailsHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                        <h4>Detalles del Pedido #${order.numero_pedido}</h4>
                        <p><strong>Estado:</strong> ${order.estado}</p>
                        <p><strong>Total:</strong> ${Utils.formatPrice(order.monto_total)}</p>
                        <h5 style="margin-top: 20px;">Productos:</h5>
                `;

                if (order.detalles && order.detalles.length > 0) {
                    order.detalles.forEach(detalle => {
                        detailsHTML += `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${detalle.producto?.nombre || 'Producto'}</strong><br>
                                Cantidad: ${detalle.cantidad} x ${Utils.formatPrice(detalle.precio_unitario)} = ${Utils.formatPrice(detalle.subtotal)}
                            </div>
                        `;
                    });
                }

                detailsHTML += '</div>';
                
                const container = document.getElementById('ordersList');
                container.insertAdjacentHTML('beforeend', detailsHTML);
            }
        }

        window.addEventListener('load', loadOrders);
    </script>
</body>
</html>

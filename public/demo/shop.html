<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda - Nexus E-commerce</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="bi bi-shop"></i> Tienda</h1>
            <p>Explora nuestro catalogo de productos</p>
        </div>

        <div class="nav-menu">
            <a href="index.html" class="nav-btn"><i class="bi bi-house"></i> Inicio</a>
            <a href="auth.html" class="nav-btn"><i class="bi bi-person"></i> Login/Registro</a>
            <a href="shop.html" class="nav-btn active"><i class="bi bi-shop"></i> Tienda</a>
            <a href="cart.html" class="nav-btn"><i class="bi bi-cart"></i> Carrito <span id="cartCount" style="background: red; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">0</span></a>
            <a href="orders.html" class="nav-btn"><i class="bi bi-box"></i> Mis Pedidos</a>
            <a href="payments.html" class="nav-btn"><i class="bi bi-credit-card"></i> Pagos</a>
        </div>

        <div class="content">
            <div id="authInfo"></div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-funnel"></i> Filtros
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="filterCategoria" onchange="loadProducts()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <select id="filterMarca" onchange="loadProducts()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Buscar</label>
                        <input type="text" id="filterSearch" placeholder="Nombre del producto..." onkeyup="loadProducts()">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-grid"></i> Productos
                </div>
                <div id="productsGrid" class="product-grid">
                    <div class="loading">Cargando productos...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-code-square"></i> Codigo de la Peticion
                </div>
                <div class="code-viewer" id="codeViewer">
                    <p style="color: #666;">El codigo de la peticion aparecera aqui...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let productos = [];
        let categorias = [];
        let marcas = [];

        async function loadFilters() {
            const catResult = await API.get('/categorias');
            const marcaResult = await API.get('/marcas');

            if (catResult.ok) {
                categorias = catResult.data.data || [];
                const select = document.getElementById('filterCategoria');
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id || cat.id_categoria;
                    option.textContent = cat.nombre || cat.nombre_categoria;
                    select.appendChild(option);
                });
            }

            if (marcaResult.ok) {
                marcas = marcaResult.data.data || [];
                const select = document.getElementById('filterMarca');
                marcas.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca.id || marca.id_marca;
                    option.textContent = marca.nombre || marca.nombre_marca;
                    select.appendChild(option);
                });
            }
        }

        async function loadProducts() {
            const categoria = document.getElementById('filterCategoria').value;
            const marca = document.getElementById('filterMarca').value;
            const search = document.getElementById('filterSearch').value;

            let endpoint = '/productos';
            const params = new URLSearchParams();
            if (categoria) params.append('categoria', categoria);
            if (marca) params.append('marca', marca);
            if (search) params.append('buscar', search);
            
            if (params.toString()) endpoint += '?' + params.toString();

            Utils.showCode('GET ' + endpoint, { filters: { categoria, marca, search } });

            const result = await API.get(endpoint);
            
            Utils.showCode('GET ' + endpoint, { filters: { categoria, marca, search }, response: result });

            if (result.ok) {
                productos = result.data.data || [];
                renderProducts();
            } else {
                document.getElementById('productsGrid').innerHTML = '<p style="color: red;">Error al cargar productos</p>';
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (productos.length === 0) {
                grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No se encontraron productos</p>';
                return;
            }

            grid.innerHTML = productos.map(producto => `
                <div class="product-card">
                    <img src="${producto.imagen_url || 'https://via.placeholder.com/250x200?text=Sin+Imagen'}" alt="${producto.nombre}">
                    <h3>${producto.nombre}</h3>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">${producto.descripcion || 'Sin descripcion'}</p>
                    <div class="price">${Utils.formatPrice(producto.precio)}</div>
                    <p style="font-size: 0.9em; color: #666;">Stock: ${producto.stock}</p>
                    <button onclick="addToCart(${producto.id_producto})" class="btn btn-primary" style="width: 100%;">
                        <i class="bi bi-cart-plus"></i> Agregar al Carrito
                    </button>
                </div>
            `).join('');
        }

        async function addToCart(productId) {
            if (!Utils.requireAuth()) return;

            const requestData = { id_producto: productId, cantidad: 1 };
            Utils.showCode('POST /carrito/agregar', { request: requestData });

            const result = await API.post('/carrito/agregar', requestData);
            
            Utils.showCode('POST /carrito/agregar', { request: requestData, response: result });

            if (result.ok) {
                Utils.showAlert('Producto agregado al carrito', 'success');
                updateCartCount();
            } else {
                Utils.showAlert(result.data.message || 'Error al agregar al carrito', 'error');
            }
        }

        async function updateCartCount() {
            if (!Auth.isAuthenticated()) return;

            const result = await API.get('/carrito');
            if (result.ok) {
                const carrito = result.data.data || {};
                const count = carrito.detalles?.length || 0;
                document.getElementById('cartCount').textContent = count;
            }
        }

        window.addEventListener('load', async () => {
            await loadFilters();
            await loadProducts();
            await updateCartCount();
        });
    </script>
</body>
</html>
